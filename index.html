<html>
<head>
<script src="https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css" rel="stylesheet" />
<link href="https://www.mapbox.com/base/latest/base.css" rel="stylesheet" />
<style>

h1 {
  background-color: #EBE7E1;
  text-align: center;
}

#container {
  width: 100%;
  height: 100%;

  display: flex;
  flex-flow: column;
}

#map {
  flex-grow: 1;
  flex-shrink: 1;
  flex-basis: auto;
}

.mapboxgl-popup {
  max-width: 400px;
  font: 12px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
}

.legend {
  background-color: #fff;
  border-radius: 3px;
  bottom: 30px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  font: 12px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
  padding: 10px;
  position: absolute;
  right: 10px;
  z-index: 1;
  width: 300px;
}

.legend h3 {
  margin: 0;
  text-align: center;
}

.legend h5 {
  margin: -3px 0 10px;
  text-align: center;
  font-size: 10px;
}

.legend .legend-item {
  display: block;
  margin-top: 5px;
}

.legend-item span {
  vertical-align: top;
}

.legend-item .percentage {
  width: 50px;
  text-align: right;
  display: inline-block;
  font-size: 10px;
  color: lightgray;
}

.legend .color-box {
  width: 20px;
  height: 20px;
  display: inline-block;
  margin-right: 5px;
  opacity: 0.7;
}

.legend .section {
  margin-top: 10px;
  margin-left: 5px;
  margin-right: 5px;
}

.legend .color-explanation {
  margin-bottom: 10px;
}
.legend .color-explanation p {
  margin: -5px 0;
}

.legend .fineprint p {
  font-size: 10px;
  color: gray;
  margin: 5px 0;
  line-height: 10px;
}
</style>
</head>
<body>
<div id="container">
  <h1>Apartment buildings are illegal to build in 78.6% of San Francisco</h1>
  <div id="map"></div>
  <div class="legend">
    <h3>Max. Allowed Homes</h3>
    <h5>(per 2,500 sq ft plot of land)</h5>
    <div class="section color-explanation">
      <p><strong style="color: red">Red</strong> means single-family or duplexes only
      <p><strong style="color: orange">Orange</strong> means triplexes or fourplexes are legal
      <p><strong style="color: green">Green</strong> means larger apartment buildings are legal
    </div>
    <div id="legend-data"></div>
    <div class="fineprint section">
      <p>2,500 sq ft is a typical lot size in San Francisco
      <p>Assumes 2.5 apartments per 10 ft of height per 2,500 sq ft
      <p>Includes <a href="http://sf-planning.org/accessory-dwelling-units" target="_blank">waiverless ADUs</a>
      <p>Many apartment buildings already exist in the red and orange areas but would be illegal to build today
      <p>You can see why new development is concentrated in the Mission, Soma, and Tenderloin neighborhoods
    </div>
  </div>
</div>

<!-- templates -->
<div style="display: none">
  <div id="popup-template">
    <h4>Details:</h4>
    {{#compare homes "<=" 0 }}
    {{#compare homes "==" -1 }}
    Open Space
    {{else}}
    <ul class="list-group">
      <li class="list-group-item">No housing allowed - Commercial / Industrial / Office use only</li>
      <li class="list-group-item">Zoning code: {{ zoning }}</li>
    </ul>
    {{/compare}}
    {{else}}
    <ul class="list-group">
      <li class="list-group-item">Homes per 2500 sq ft: {{round homes 3}}</li>
      <li class="list-group-item">Max homes due to zoning code:
        {{#compare homes_zoning ">" 10000 }}
        No limit
        {{else}}
        {{round homes_zoning 3}}
        {{/compare}}
      </li>
      <li class="list-group-item">Max homes due to height limit: {{round homes_height 3}}</li>
      <li class="list-group-item">Zoning code: {{ zoning }}</li>
      <li class="list-group-item">Height limit code: {{ height_str }}</li>
    </ul>
    {{/compare}}
  </div>
  <div id="legend-item-template">
    <div class="legend-item">
      <span class="percentage">
      {{ percentage }}%
      </span>
      <span class="color-box" style="background-color: {{ color }}">
      </span>
      <span>
        {{#compare num ">" 20 }}
        more than 20
        {{else}}{{#compare num "==" -1 }}
        Open Space
        {{else}}{{#compare num "==" 0 }}
        0 (No housing)
        {{else}}
        {{ num }}
        {{/compare}}{{/compare}}{{/compare}}
      </span>
    </div>
  </div>
</div>
<!-- end templates -->

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZGltdmEiLCJhIjoiY2plYzhtMTM5MG5yazJ4bGE0OHZrcHpnZCJ9.u9hqKMLwpq-JHGyhAW2GeQ';

Handlebars.registerHelper('round', function(num, places, options) {
    if (arguments.length < 3) {
      throw new Error("Handlebars Helper round needs 2 parameters");
    }
    var e = Math.pow(10, places);
    return Math.round(num*e) / e;
});

function htmlDecode(input)
{
  var doc = new DOMParser().parseFromString(input, "text/html");
  return doc.documentElement.textContent;
}

Handlebars.registerHelper('compare', function (lvalue, operator, rvalue, options) {

    var operators, result;

    if (arguments.length < 3) {
        throw new Error("Handlerbars Helper 'compare' needs 2 parameters");
    }

    if (options === undefined) {
        options = rvalue;
        rvalue = operator;
        operator = "===";
    }

    operator = htmlDecode(operator);

    operators = {
        '==': function (l, r) { return l == r; },
        '===': function (l, r) { return l === r; },
        '!=': function (l, r) { return l != r; },
        '!==': function (l, r) { return l !== r; },
        '<': function (l, r) { return l < r; },
        '>': function (l, r) { return l > r; },
        '<=': function (l, r) { return l <= r; },
        '>=': function (l, r) { return l >= r; },
        'typeof': function (l, r) { return typeof l == r; }
    };

    if (!operators[operator]) {
        throw new Error("Handlerbars Helper 'compare' doesn't know the operator " + operator);
    }

    result = operators[operator](lvalue, rvalue);

    if (result) {
        return options.fn(this);
    } else {
        return options.inverse(this);
    }

});

var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/mapbox/streets-v9',
    center: [-122.42936665634733, 37.75967613988033], // starting position
    zoom: 11.75 // starting zoom
});

// disable map rotation using right click + drag
map.dragRotate.disable();

// disable map rotation using touch rotation gesture
map.touchZoomRotate.disableRotation();

// Add zoom and rotation controls to the map.
map.addControl(new mapboxgl.NavigationControl({showCompass: false}));

var popupTemplate = Handlebars.compile(document.getElementById("popup-template").innerHTML);
var legendItemTemplate = Handlebars.compile(document.getElementById("legend-item-template").innerHTML);

var KEY_DATA = [
  {
    "color": "gray",
    "homes": -1,
    "percentage": 32.08307863407301
  },
  {
    "color": "#3b0000",
    "homes": 0,
    "percentage": 10.050558016216783
  },
  {
    "color": "#950004",
    "homes": 1.25,
    "percentage": 7.363627652698533
  },
  {
    "color": "#c60003",
    "homes": 2,
    "percentage": 29.045071491562908
  },
  {
    "color": "#ff0000",
    "homes": 2.5,
    "percentage": 0.03138626345787019
  },
  {
    "color": "#ff6e00",
    "homes": 3,
    "percentage": 3.239481888371228
  },
  {
    "color": "#ff8300",
    "homes": 3.125,
    "percentage": 5.117287426187047
  },
  {
    "color": "#ffbb00",
    "homes": 4.166666666666667,
    "percentage": 2.4721982542381635
  },
  {
    "color": "#ffff00",
    "homes": 5.0,
    "percentage": 2.84629275689778e-09
  },
  {
    "color": "#deec00",
    "homes": 6.25,
    "percentage": 1.37776937177379
  },
  {
    "color": "#bed900",
    "homes": 7.5,
    "percentage": 0.007853922526348209
  },
  {
    "color": "#9ec500",
    "homes": 10.0,
    "percentage": 1.8856732168991333
  },
  {
    "color": "#7eb100",
    "homes": 12.5,
    "percentage": 2.185190764242557
  },
  {
    "color": "#609e00",
    "homes": 15.0,
    "percentage": 0.9742242094562791
  },
  {
    "color": "#428c00",
    "homes": 17.5,
    "percentage": 0.009225311627956348
  },
  {
    "color": "#207700",
    "homes": 20.0,
    "percentage": 0.4630441407062209
  },
  {
    "color": "#006400",
    "homes": 22.5,
    "percentage": 3.6715952783795274
  }
];

map.on('load', function () {
  map.addLayer({
      'id': 'zones-layer',
      'type': 'fill',
      'source': {
          'type': 'geojson',
          'data': 'generated/res2.geojson'
      },
      'paint': {
          'fill-opacity': 0.7,
          'fill-color': ['get', 'fill']
      }
  });

    // When a click event occurs on a feature in the states layer, open a popup at the
    // location of the click, with description HTML from its properties.
    map.on('click', 'zones-layer', function (e) {
      var prop = e.features[0].properties;
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(popupTemplate(prop))
            .addTo(map);
    });

    var legend = document.getElementById('legend-data');

    KEY_DATA.forEach(function(data) {
      var roundedPercentage = Math.round(10*data['percentage'])/10;
      if (roundedPercentage == 0) {
        return;
      }
      legend.insertAdjacentHTML('beforeend', legendItemTemplate({
            num: Math.round(data['homes']*1000)/1000,
            percentage: roundedPercentage.toFixed(1),
            color: data['color']
      }));
    });
});

</script>
</body>
</html>
