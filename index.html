<html>
<head>
<script src="https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css" rel="stylesheet" />
<link href="https://www.mapbox.com/base/latest/base.css" rel="stylesheet" />
<style>
#map {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
}

.mapboxgl-popup {
  max-width: 400px;
  font: 12px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
}

.legend {
  background-color: #fff;
  border-radius: 3px;
  bottom: 30px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  font: 12px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
  padding: 10px;
  position: absolute;
  right: 10px;
  z-index: 1;
}

.legend h4 {
  margin: 0 0 10px;
  text-align: center;
}

.legend p {
  margin-left: 30px;
  position: absolute;
  display: block;
  top: 0;
}

.legend div {
  position: relative;
}

.legend div span {
  width: 20px;
  height: 20px;
  display: inline-block;
  margin-right: 5px;
  opacity: 0.7;
}

.legend .fineprint {
  font-size: 10px;
  font-color: lightgray;
}
</style>
</head>
<body>
<div id="map"></div>
<div class="legend">
  <h4>Max. Allowed Homes<br/>
    per 2,500 sq ft</h4>
  <div id="legend"></div>
  <p class="fineprint">2,500 sq ft is a typical lot size in San Francisco
  <p class="fineprint">Includes waiverless ADUs
  <p class="fineprint">Assumes 2.5 apartments per floor per 2,500 sq ft
</div>

<!-- templates -->
<div style="display: none">
  <div id="popup-template">
    <h4>Details:</h4>
    {{#compare homes "<=" 0 }}
    {{#compare homes "==" -1 }}
    Open Space
    {{else}}
    No housing allowed - Commercial / Industrial / Office use only
    {{/compare}}
    {{else}}
    <ul class="list-group">
      <li class="list-group-item">Homes per 2500 sq ft: {{round homes 3}}</li>
      <li class="list-group-item">Max homes due to zoning code:
        {{#compare homes_zoning ">" 10000 }}
        No limit
        {{else}}
        {{round homes_zoning 3}}
        {{/compare}}
      </li>
      <li class="list-group-item">Max homes due to height limit: {{round homes_height 3}}</li>
      <li class="list-group-item">Zoning code: {{ zoning }}</li>
      <li class="list-group-item">Height limit code: {{ height_str }}</li>
    </ul>
    {{/compare}}
  </div>
  <div id="legend-item-template">
    <div>
      <span style="background-color: {{ color }}">
        {{ percentage }}%
      </span>
      <p>
        {{#compare num ">" 20 }}
        &gt; 20
        {{else}}{{#compare num "==" -1 }}
        Open Space
        {{else}}{{#compare num "==" 0 }}
        0 (No housing)
        {{else}}
        {{ num }}
        {{/compare}}{{/compare}}{{/compare}}
      </p>
    </div>
  </div>
</div>
<!-- end templates -->

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZGltdmEiLCJhIjoiY2plYzhtMTM5MG5yazJ4bGE0OHZrcHpnZCJ9.u9hqKMLwpq-JHGyhAW2GeQ';

Handlebars.registerHelper('round', function(num, places, options) {
    if (arguments.length < 3) {
      throw new Error("Handlebars Helper round needs 2 parameters");
    }
    var e = Math.pow(10, places);
    return Math.round(num*e) / e;
});

function htmlDecode(input)
{
  var doc = new DOMParser().parseFromString(input, "text/html");
  return doc.documentElement.textContent;
}

Handlebars.registerHelper('compare', function (lvalue, operator, rvalue, options) {

    var operators, result;

    if (arguments.length < 3) {
        throw new Error("Handlerbars Helper 'compare' needs 2 parameters");
    }

    if (options === undefined) {
        options = rvalue;
        rvalue = operator;
        operator = "===";
    }

    operator = htmlDecode(operator);

    operators = {
        '==': function (l, r) { return l == r; },
        '===': function (l, r) { return l === r; },
        '!=': function (l, r) { return l != r; },
        '!==': function (l, r) { return l !== r; },
        '<': function (l, r) { return l < r; },
        '>': function (l, r) { return l > r; },
        '<=': function (l, r) { return l <= r; },
        '>=': function (l, r) { return l >= r; },
        'typeof': function (l, r) { return typeof l == r; }
    };

    if (!operators[operator]) {
        throw new Error("Handlerbars Helper 'compare' doesn't know the operator " + operator);
    }

    result = operators[operator](lvalue, rvalue);

    if (result) {
        return options.fn(this);
    } else {
        return options.inverse(this);
    }

});

var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/mapbox/streets-v9',
    center: [-122.42936665634733, 37.75967613988033], // starting position
    zoom: 11.75 // starting zoom
});

// disable map rotation using right click + drag
map.dragRotate.disable();

// disable map rotation using touch rotation gesture
map.touchZoomRotate.disableRotation();

// Add zoom and rotation controls to the map.
map.addControl(new mapboxgl.NavigationControl({showCompass: false}));

var popupTemplate = Handlebars.compile(document.getElementById("popup-template").innerHTML);
var legendItemTemplate = Handlebars.compile(document.getElementById("legend-item-template").innerHTML);

var KEY_DATA = [
  {
    "color": "gray",
    "percentage": 32.08307863407301,
    "homes1000": -1000
  },
  {
    "color": "#3b0000",
    "percentage": 10.050558016216783,
    "homes1000": 0
  },
  {
    "color": "#950004",
    "percentage": 7.363627652698533,
    "homes1000": 1250
  },
  {
    "color": "#c60003",
    "percentage": 29.045071491562908,
    "homes1000": 2000
  },
  {
    "color": "#ff0000",
    "percentage": 0.03138626345787019,
    "homes1000": 2500
  },
  {
    "color": "#ff6e00",
    "percentage": 3.239481888371228,
    "homes1000": 3000
  },
  {
    "color": "#ff8300",
    "percentage": 5.117287426187047,
    "homes1000": 3125
  },
  {
    "color": "#ffbb00",
    "percentage": 2.4721982542381635,
    "homes1000": 4167
  },
  {
    "color": "#ffff00",
    "percentage": 2.84629275689778e-09,
    "homes1000": 5000
  },
  {
    "color": "#deec00",
    "percentage": 1.37776937177379,
    "homes1000": 6250
  },
  {
    "color": "#bed900",
    "percentage": 0.007853922526348209,
    "homes1000": 7500
  },
  {
    "color": "#9ec500",
    "percentage": 1.8856732168991333,
    "homes1000": 10000
  },
  {
    "color": "#7eb100",
    "percentage": 2.185190764242557,
    "homes1000": 12500
  },
  {
    "color": "#609e00",
    "percentage": 0.9742242094562791,
    "homes1000": 15000
  },
  {
    "color": "#428c00",
    "percentage": 0.009225311627956348,
    "homes1000": 17500
  },
  {
    "color": "#207700",
    "percentage": 0.4630441407062209,
    "homes1000": 20000
  },
  {
    "color": "#006400",
    "percentage": 3.6715952783795274,
    "homes1000": 22500
  }
];

map.on('load', function () {
  map.addLayer({
      'id': 'zones-layer',
      'type': 'fill',
      'source': {
          'type': 'geojson',
          'data': '/res2.geojson'
      },
      'paint': {
          'fill-opacity': 0.7,
          'fill-color': ['get', 'fill']
      }
  });

    // When a click event occurs on a feature in the states layer, open a popup at the
    // location of the click, with description HTML from its properties.
    map.on('click', 'zones-layer', function (e) {
      var prop = e.features[0].properties;
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(popupTemplate(prop))
            .addTo(map);
    });

    var legend = document.getElementById('legend');

    KEY_DATA.forEach(function(data) {
      var n = data['homes1000'] / 1000;
      var roundedPercentage = Math.round(10*data['percentage'])/10;
      if (roundedPercentage == 0) {
        return;
      }
      legend.insertAdjacentHTML('beforeend', legendItemTemplate({
            num: n,
            percentage: roundedPercentage,
            color: data['color']
      }));
    });
});

</script>
</body>
</html>
