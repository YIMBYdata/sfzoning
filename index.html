<html>
<head>
<script src='https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
<link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
<style>
#map {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
}

.mapboxgl-popup {
  max-width: 400px;
  font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
}

.legend {
  background-color: #fff;
  border-radius: 3px;
  bottom: 30px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
  padding: 10px;
  position: absolute;
  right: 10px;
  z-index: 1;
}

.legend h4 {
  margin: 0 0 10px;
}

.legend p {
  margin-left: 30px;
  position: absolute;
  display: block;
  top: 0;
}

.legend div {
  position: relative;
}

.legend div span {
  width: 20px;
  height: 20px;
  display: inline-block;
  margin-right: 5px;
  opacity: 0.7;
}
</style>
</head>
<body>
<div id='map'></div>
<div id='legend' class='legend'>
  <h4>Homes per 2,500 sq ft</h4>
</div>

<!-- templates -->
<div style="display: none">
  <div id='popup-template'>
    <h5>Detail:</h5>
    {{#compare homes "==" -1 }}
    Open Space
    {{else}}
    <ul class="list-group">
      <li class="list-group-item">Homes per 2500 sq ft: {{round homes 3}}</li>
      <li class="list-group-item">Max homes due to zoning code:
        {{#compare homes_zoning ">" 10000 }}
        No limit
        {{else}}
        {{round homes_zoning 3}}
        {{/compare}}
      </li>
      <li class="list-group-item">Max homes due to height limit: {{round homes_height 3}}</li>
      <li class="list-group-item">Zoning code: {{ zoning }}</li>
      <li class="list-group-item">Height limit code: {{ height_str }}</li>
    </ul>
    {{/compare}}
  </div>
  <div id="legend-item-template">
    <div>
      <span style="background-color: {{ color }}"></span>
      <p>
        {{#compare num ">" 20 }}
        &gt; 20
        {{else}}{{#compare num "==" -1 }}
        Open Space
        {{else}}{{#compare num "==" 0 }}
        0 (No housing)
        {{else}}
        {{ num }}
        {{/compare}}{{/compare}}{{/compare}}
      </p>
    </div>
  </div>
</div>
<!-- end templates -->

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZGltdmEiLCJhIjoiY2plYzhtMTM5MG5yazJ4bGE0OHZrcHpnZCJ9.u9hqKMLwpq-JHGyhAW2GeQ';

Handlebars.registerHelper('round', function(num, places, options) {
    if (arguments.length < 3) {
      throw new Error("Handlebars Helper round needs 2 parameters");
    }
    var e = Math.pow(10, places);
    return Math.round(num*e) / e;
});

function htmlDecode(input)
{
  var doc = new DOMParser().parseFromString(input, "text/html");
  return doc.documentElement.textContent;
}

Handlebars.registerHelper('compare', function (lvalue, operator, rvalue, options) {

    var operators, result;

    if (arguments.length < 3) {
        throw new Error("Handlerbars Helper 'compare' needs 2 parameters");
    }

    if (options === undefined) {
        options = rvalue;
        rvalue = operator;
        operator = "===";
    }

    operator = htmlDecode(operator);

    operators = {
        '==': function (l, r) { return l == r; },
        '===': function (l, r) { return l === r; },
        '!=': function (l, r) { return l != r; },
        '!==': function (l, r) { return l !== r; },
        '<': function (l, r) { return l < r; },
        '>': function (l, r) { return l > r; },
        '<=': function (l, r) { return l <= r; },
        '>=': function (l, r) { return l >= r; },
        'typeof': function (l, r) { return typeof l == r; }
    };

    if (!operators[operator]) {
        throw new Error("Handlerbars Helper 'compare' doesn't know the operator " + operator);
    }

    result = operators[operator](lvalue, rvalue);

    if (result) {
        return options.fn(this);
    } else {
        return options.inverse(this);
    }

});

var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/mapbox/streets-v9',
    center: [-122.42936665634733, 37.75967613988033], // starting position
    zoom: 11.75 // starting zoom
});

// disable map rotation using right click + drag
map.dragRotate.disable();

// disable map rotation using touch rotation gesture
map.touchZoomRotate.disableRotation();

// Add zoom and rotation controls to the map.
map.addControl(new mapboxgl.NavigationControl({showCompass: false}));

var popupTemplate = Handlebars.compile(document.getElementById("popup-template").innerHTML);
var legendItemTemplate = Handlebars.compile(document.getElementById("legend-item-template").innerHTML);

var COLORS = {
  "-1000": "gray",
  "0": "#3b0000",
  "10000": "#9ec500",
  "2500": "#ff0000",
  "4166": "#ffbb00",
  "1000": "#950004",
  "6250": "#deec00",
  "7500": "#bed900",
  "2000": "#c60003",
  "625": "#6d0003",
  "5000": "#ffff00",
  "3000": "#ff6e00",
  "12500": "#7eb100",
  "3125": "#ff8300",
  "20000": "#207700",
  "22500": "#006400",
  "17500": "#428c00",
  "15000": "#609e00"
};

map.on('load', function () {
  map.addLayer({
      'id': 'zones-layer',
      'type': 'fill',
      'source': {
          'type': 'geojson',
          'data': '/res2.geojson'
      },
      'paint': {
          'fill-opacity': 0.7,
          'fill-color': ['get', 'fill']
      }
  });

    // When a click event occurs on a feature in the states layer, open a popup at the
    // location of the click, with description HTML from its properties.
    map.on('click', 'zones-layer', function (e) {
      var prop = e.features[0].properties;
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(popupTemplate(prop))
            .addTo(map);
    });

    var legend = document.getElementById('legend');

    var nums = Object.keys(COLORS);
    nums.sort(function(a, b) { return a - b; });
    nums.forEach(function(numStr) {
      var n = Number(numStr) / 1000;
      legend.insertAdjacentHTML('beforeend', legendItemTemplate({
            num: n,
            color: COLORS[numStr]
      }));
    });
});

</script>
</body>
</html>
